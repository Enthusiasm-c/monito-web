# Сводка проблем monito-web

## 1. Проблемы с базой данных

### ✅ РЕШЕНО: Проблема с Bali Boga PDF
- **Проблема**: Обрезка на 145 товарах из 252
- **Решение**: Увеличен лимит токенов и добавлен компактный формат JSON для больших файлов
- **Результат**: Успешно извлекаются все 252 товара

### ❌ Проблема с сохранением в БД
- **Проблема**: Ошибка "The table `public.Supplier` does not exist" 
- **Причина**: Проблема с регистром таблиц или кешем Prisma клиента
- **Требуется**: Перезапуск сервера после `npx prisma generate`

### ❌ Проблема с полем updatedAt
- **Проблема**: "Argument `updatedAt` is missing" при создании продуктов
- **Причина**: Prisma должна автоматически управлять этим полем через @updatedAt
- **Требуется**: Проверить версию Prisma и конфигурацию

## 2. Проблемы с обработкой файлов

### ✅ PDF файлы
- **Статус**: Работают хорошо
- `bali boga.pdf` - 252 товара ✅
- `VALENTA cheese.pdf` - 47 товаров ✅
- `milk up.pdf` - 72 товара ✅

### ✅ Изображения
- **Статус**: Работают через OCR
- `munch bakery.jpg` - 48 товаров ✅

### ❌ Excel файлы
- **Проблема 1**: "No data found in Excel file" для Oka veg supplier.xlsx
- **Проблема 2**: JSON parse error для sri 2 vegetables.xlsx
- **Причина**: 
  1. Gemini API не поддерживает Excel напрямую
  2. Наш препроцессор может неправильно определять структуру данных
  3. Файлы могут содержать графики или сложное форматирование

## 3. Проблемы с API

### ❌ Ошибка 500 при загрузке
- **Причина**: Проблема с Prisma клиентом после миграций
- **Решение**: 
  1. `npx prisma generate`
  2. Перезапустить dev сервер
  3. Убедиться что переменные окружения загружены

## 4. Рекомендации по исправлению

### Срочно:
1. **Перезапустить сервер** после регенерации Prisma клиента
2. **Исправить Excel обработку**:
   - Улучшить определение заголовков
   - Пропускать листы с графиками
   - Добавить логирование для отладки

### Важно:
1. **Добавить транзакции** для атомарности операций
2. **Улучшить обработку ошибок** с rollback
3. **Добавить retry логику** для временных сбоев

### Желательно:
1. **Оптимизировать производительность** для больших файлов
2. **Добавить прогресс-бар** для длительных операций
3. **Улучшить валидацию** данных перед сохранением

## 5. Статистика успешности

- **PDF**: 100% успешность извлечения
- **Изображения**: 100% успешность
- **Excel**: 0% успешность (требует доработки)
- **Сохранение в БД**: 0% из-за проблем с Prisma

## Следующие шаги

1. Перезапустить сервер с обновленным Prisma клиентом
2. Исправить Excel препроцессор
3. Добавить обработку ошибок БД
4. Протестировать все файлы снова